<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>玄学state | 叩首问路，码梦为生</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.svg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#53A8FF">
    <meta name="description" content="你好，我叫郭二蛋，欢迎你来到这里">
    <meta name="theme-color" content="#53A8FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.6a70634b.css" as="style"><link rel="preload" href="/assets/js/app.856bad6d.js" as="script"><link rel="preload" href="/assets/js/2.6a99c285.js" as="script"><link rel="preload" href="/assets/js/15.8723ac38.js" as="script"><link rel="preload" href="/assets/js/8.396b1803.js" as="script"><link rel="prefetch" href="/assets/js/10.960a6655.js"><link rel="prefetch" href="/assets/js/11.3bde5e34.js"><link rel="prefetch" href="/assets/js/12.de934909.js"><link rel="prefetch" href="/assets/js/13.717e8502.js"><link rel="prefetch" href="/assets/js/14.0b0f6fde.js"><link rel="prefetch" href="/assets/js/16.8db0111f.js"><link rel="prefetch" href="/assets/js/17.70d1e644.js"><link rel="prefetch" href="/assets/js/18.e6853a29.js"><link rel="prefetch" href="/assets/js/19.2fd51b30.js"><link rel="prefetch" href="/assets/js/20.c72340f4.js"><link rel="prefetch" href="/assets/js/21.9d0b3d30.js"><link rel="prefetch" href="/assets/js/22.ce12d2f1.js"><link rel="prefetch" href="/assets/js/23.cfdf6604.js"><link rel="prefetch" href="/assets/js/24.6b70f8b5.js"><link rel="prefetch" href="/assets/js/25.64dd0228.js"><link rel="prefetch" href="/assets/js/26.bd137f35.js"><link rel="prefetch" href="/assets/js/27.e091a131.js"><link rel="prefetch" href="/assets/js/28.e0f88969.js"><link rel="prefetch" href="/assets/js/29.e3fdaaa2.js"><link rel="prefetch" href="/assets/js/3.7031cefa.js"><link rel="prefetch" href="/assets/js/30.115d56d0.js"><link rel="prefetch" href="/assets/js/31.0c91284c.js"><link rel="prefetch" href="/assets/js/32.f436709f.js"><link rel="prefetch" href="/assets/js/33.aec02913.js"><link rel="prefetch" href="/assets/js/34.5f0c80a1.js"><link rel="prefetch" href="/assets/js/35.6c57a5b9.js"><link rel="prefetch" href="/assets/js/36.874bc2bc.js"><link rel="prefetch" href="/assets/js/37.9d3e55d1.js"><link rel="prefetch" href="/assets/js/38.664eac9a.js"><link rel="prefetch" href="/assets/js/39.38e15cf0.js"><link rel="prefetch" href="/assets/js/4.cf227334.js"><link rel="prefetch" href="/assets/js/40.1eb39796.js"><link rel="prefetch" href="/assets/js/41.21813454.js"><link rel="prefetch" href="/assets/js/42.c366e57e.js"><link rel="prefetch" href="/assets/js/43.2ed90fb6.js"><link rel="prefetch" href="/assets/js/44.8b7ed554.js"><link rel="prefetch" href="/assets/js/45.e65eba18.js"><link rel="prefetch" href="/assets/js/46.e219420f.js"><link rel="prefetch" href="/assets/js/47.47adaa89.js"><link rel="prefetch" href="/assets/js/48.1e2c3ed7.js"><link rel="prefetch" href="/assets/js/49.430a2613.js"><link rel="prefetch" href="/assets/js/5.1f81c3e9.js"><link rel="prefetch" href="/assets/js/50.4cb51013.js"><link rel="prefetch" href="/assets/js/51.48e00036.js"><link rel="prefetch" href="/assets/js/52.2e53b9ba.js"><link rel="prefetch" href="/assets/js/53.566a6fbd.js"><link rel="prefetch" href="/assets/js/54.740bb41a.js"><link rel="prefetch" href="/assets/js/55.276e7e98.js"><link rel="prefetch" href="/assets/js/56.42aa3b98.js"><link rel="prefetch" href="/assets/js/57.5c66fa93.js"><link rel="prefetch" href="/assets/js/58.73423f17.js"><link rel="prefetch" href="/assets/js/59.e9354a5e.js"><link rel="prefetch" href="/assets/js/6.e00d9635.js"><link rel="prefetch" href="/assets/js/60.d37d1a47.js"><link rel="prefetch" href="/assets/js/61.5608bf0d.js"><link rel="prefetch" href="/assets/js/62.e318dfd6.js"><link rel="prefetch" href="/assets/js/63.74fca516.js"><link rel="prefetch" href="/assets/js/64.81eb34e4.js"><link rel="prefetch" href="/assets/js/65.ef4b9d8a.js"><link rel="prefetch" href="/assets/js/66.1ff64233.js"><link rel="prefetch" href="/assets/js/67.89044667.js"><link rel="prefetch" href="/assets/js/7.f63888e1.js"><link rel="prefetch" href="/assets/js/9.97c83bcc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6a70634b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">叩首问路，码梦为生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study/index.html" class="nav-link">
  学习
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  问题
</a></div><div class="nav-item"><a href="/document/index.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/read/index.html" class="nav-link">
  读书
</a></div> <a href="https://github.com/guozhaoxi/vuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study/index.html" class="nav-link">
  学习
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  问题
</a></div><div class="nav-item"><a href="/document/index.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/read/index.html" class="nav-link">
  读书
</a></div> <a href="https://github.com/guozhaoxi/vuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/react/first.html" class="sidebar-link">使用antd来美化我们的界面样式</a></li><li><a href="/study/react/component.html" class="sidebar-link">React 组件</a></li><li><a href="/study/react/state.html" aria-current="page" class="active sidebar-link">玄学state</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/react/state.html#类组件中的state" class="sidebar-link">类组件中的state</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/react/state.html#setstate用法" class="sidebar-link">setState用法</a></li><li class="sidebar-sub-header"><a href="/study/react/state.html#基本用法" class="sidebar-link">基本用法</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/react/state.html#函数组件中的state" class="sidebar-link">函数组件中的state</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/react/state.html#usestate用法" class="sidebar-link">useState用法</a></li><li class="sidebar-sub-header"><a href="/study/react/state.html#如何监听state变化" class="sidebar-link">如何监听state变化？</a></li><li class="sidebar-sub-header"><a href="/study/react/state.html#usestate原理揭秘" class="sidebar-link">useState原理揭秘</a></li></ul></li></ul></li><li><a href="/study/react/props.html" class="sidebar-link">props</a></li><li><a href="/study/react/lifeCycle.html" class="sidebar-link">理解lifeCycle</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/vue/first.html" class="sidebar-link">学习vue相关的笔记</a></li><li><a href="/study/vue/standard.html" class="sidebar-link">编程规范解决方案之ESLint + Git Hooks</a></li><li><a href="/study/vue/login.html" class="sidebar-link">项目架构之搭建登录架构解决方案与实现</a></li><li><a href="/study/vue/layout.html" class="sidebar-link">项目架构之搭建Layout架构 解决方案与实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/design-mode/adapter.html" class="sidebar-link">适配器模式</a></li><li><a href="/study/design-mode/watcher.html" class="sidebar-link">观察者模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>微信小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/miniprogram/first.html" class="sidebar-link">微信小程序基础用法</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="玄学state"><a href="#玄学state" class="header-anchor">#</a> 玄学state</h1> <h2 id="类组件中的state"><a href="#类组件中的state" class="header-anchor">#</a> 类组件中的state</h2> <h3 id="setstate用法"><a href="#setstate用法" class="header-anchor">#</a> setState用法</h3> <p>React项目中UI的改变来源于state改变，类组件中<code>setState</code>是更新组件，渲染视图的主要方式。</p> <h3 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>第一个参数：当obj为一个对象时，则为即将合并的state；如果obj是一个函数，那么当前组件的state和props将作为参数，返回值用于合并新的state。</p></li> <li><p>第二个参数callback： callback为一个函数，函数执行上下文中可以获取当前setState更新后的最新state值，可以作为依赖state变化的副作用函数，可以用来做一些基于DOM的操作。</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* 第一个参数为function类型 */</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 第一个参数为object类型 */</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>number<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>假如在一次事件中触发了一次如上setState，在React底层主要做了哪些事呢？</p> <ul><li><p>首先，setState会产生当前更新的优先级（老版本用expirationTime, 新版本用lane）</p></li> <li><p>接下来，React会从fiber Root根部 fiber 向下调和子节点，调和阶段将对比发生更新的地方，更新对比expirationTime,找到发生更新的组件，合并state,然后触发render函数，得到新的UI视图层，完成render阶段。</p></li> <li><p>接下来到commit阶段，commit阶段，替换真实DOM,完成此次更新流程。</p></li> <li><p>此时仍然在commit阶段，会执行setState中的callback函数，如上的<br> <code>（）=&gt; {console.log(this.state.number)}</code>函数体内容，到此为止完成了一次setState全过程。</p></li></ul> <p><strong>更新的流程图如下</strong></p> <p><img src="/assets/img/setState.7dd6c76b.png" alt="setState更新流程图" title="setState更新流程图"></p> <p><strong>要记住的任务先后顺序：</strong> render阶段 render函数执行 -&gt; commit阶段 替换真实DOM -&gt; setState 回调函数执行 callback</p> <p><strong>类组件如何限制state更新视图</strong></p> <ul><li><p>pureComponent可以对state和props进行浅比较，如果没有发生变化，那么组件不更新。</p></li> <li><p>shouldComponentUpdate生命周期可以通过判断前后state变化来决定组件需不需要更新，需要更新饭绘true,否则返回false。</p></li></ul> <p>React同一级别<strong>更新优先级</strong>关系是：</p> <p>flushSync中的setState &gt; 正常执行上下文中setState &gt; setTimeout, Promise中的setState。</p> <h2 id="函数组件中的state"><a href="#函数组件中的state" class="header-anchor">#</a> 函数组件中的state</h2> <h3 id="usestate用法"><a href="#usestate用法" class="header-anchor">#</a> useState用法</h3> <p><strong>基本用法</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initData<span class="token punctuation">)</span>
</code></pre></div><ul><li>state,目的提供给UI，作为渲染视图的数据源。</li> <li>dispatch 改变state的函数，可以理解为推动函数组件渲染的渲染函数。</li> <li>initData有两种情况，第一种是非函数，将作为state初始化的值。第二种情况是函数，返回值作为useState初始化的值。</li></ul> <p>initData为非函数的情况：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>initData为函数的情况：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>a <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>a <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>对于dispatch的参数也有两种情况：</p> <ul><li><p>第一种非函数情况，此时将作为新的值，赋予state,作为下一次渲染使用。</p></li> <li><p>第二种函数情况，如果dispatch的参数是一个函数，这里可以称它为reducer, reducer的参数，是上一次返回最新的state, 返回值作为新的state。</p></li></ul> <p><strong>dispatch参数是一个非函数</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cosnt <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// state -&gt;  1</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">// state -&gt;  2</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">// state -&gt;  3</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>dispatch参数是一个函数</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cosnt <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prevState <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// state -&gt;  0 + 1 = 1</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">// state -&gt;  10</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prevState <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// state-&gt; 10 + 1 == 11</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="如何监听state变化"><a href="#如何监听state变化" class="header-anchor">#</a> 如何监听state变化？</h3> <p>在类组件setState中，可以通过第二个参数callback或者是生命周期componentDidUpdate检测监听到state改变或是组件更新。</p> <p>那么在函数组件中，如何监听state变化呢？这个时候就需要<code>useEffect</code>出场了，通常可以把state作为依赖项传入useEffect第二个参数deps,但是注意useEffect初始化会默认执行一次。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> number<span class="token punctuation">,</span> setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'监听number变化，此时的number是: '</span> <span class="token operator">+</span> number<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>number<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        ReactDOM<span class="token punctuation">.</span><span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span> number <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick <span class="token operator">=</span> <span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>click me<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>dispatch更新特点</strong></p> <p>useState有一点值得注意的是：当调用改变state的函数dispatch，在本次函数执行上下文中，是获取不到最新的state值的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span> number<span class="token punctuation">,</span> setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        ReactDOM<span class="token punctuation">.</span><span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>原因很简单，函数组件更新就是函数的执行，在函数一次执行过程中，函数内部所有变量重新声明，所以改变的state，只有在下一次函数组件执行时才会被更新，所以如上同一个函数执行上下文中，number一直为0，无论怎么打印，都拿不到最新的state。</p> <p><strong>useState注意事项</strong></p> <p>在使用useState的dispatchAction更新state的时候，记得不要传入相同的state,这样会使视图不更新。比如下面这么写：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatchState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;guozhaoxi&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 点击按钮，视图没有更新</span>
        state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;guoerdan&quot;</span>
        <span class="token function">dispatchState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>   <span class="token comment">// 直接改变state,在内存中指向的地址相同</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span> state<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>changeName<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在useState的dispatchState处理逻辑中，会浅比较两次state,发现state相同，不会开启更新调度任务；demo中两次state指向了相同的内存空间，所以默认state相等，就不会发生视图更新了。</p> <p>解决上述问题：将dispatchState改为dispatchState({...state})根本解决了问题，浅拷贝了对象，重新申请了一个新的内存空间。</p> <h3 id="usestate原理揭秘"><a href="#usestate原理揭秘" class="header-anchor">#</a> useState原理揭秘</h3> <p>类组件中的<code>setState</code>和函数组件中的<code>useState</code>有什么异同？</p> <p>相同点： 首先从原理角度出发， setState和useState更新视图，底层都调用了scheduleUpdateOnFiber方法，而且事件驱动情况下都有批量更新规则。</p> <p><strong>不同点</strong></p> <ul><li><p>在不是pureComponent组件模式下，setState不会浅比较两次state的值，只要调用setState，在没有其他优化手段的前提下，就会执行更新，但是useState中的dispatchAction会默认比较两次state是否相同，然后决定是否更新组件。</p></li> <li><p>setState有专门监听state变化的回调函数callback，可以获取最新state; 但是在函数组件中，只能通过useEffect来执行state变化引起的副作用。</p></li> <li><p>setState在底层逻辑上主要是和老state进行合并处理，而useState更倾向于重新赋值。</p></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/guozhaoxi/edit/master/docs/study/react/state.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/25/2021, 7:28:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/react/component.html" class="prev">
        React 组件
      </a></span> <span class="next"><a href="/study/react/props.html">
        props
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.856bad6d.js" defer></script><script src="/assets/js/2.6a99c285.js" defer></script><script src="/assets/js/15.8723ac38.js" defer></script><script src="/assets/js/8.396b1803.js" defer></script>
  </body>
</html>
